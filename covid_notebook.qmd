---
title: "Travail d'analyse: Les effets du confinement durant le covid sur divers paramètres sociaux et économiques."
author: "Achille Dekkers, Maxime Pourtois, Oguzhan Dogru, Tanguy Deprez "
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

Les données de mortalité cumulée mensuelle entre 1992 et 2021 proviennent du site de l'office des statistiques de Belgique : <https://statbel.fgov.be/fr/themes/population/mortalite-et-esperance-de-vie/tables-de-mortalite-et-esperance-de-vie>

L'analyse est réalisée avec la [SciViews Box 2025](https://www.sciviews.org/software/svbox/) dans [Saturn Cloud](https://saturncloud.io) (Linux Ubuntu 22.04), utilisant le [logiciel R](https://www.r-project.org) (`r R.version.string`). Le package {pastecs} version `r packageVersion("pastecs")` est utilisé pour étudier la série temporelle.

C'est pas la version finale c'est juste pour avoir une référence.

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts", lang = "fr")
feur <- read("data/mobility_wallonia.rds")
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

```{r}

feur %>.%
  smutate(., 
    "retail" = retail_and_recreation_percent_change_from_baseline,
    "grocery" = grocery_and_pharmacy_percent_change_from_baseline,
    "parks" = parks_percent_change_from_baseline,
    "transit" = transit_stations_percent_change_from_baseline,
    "workplaces" = workplaces_percent_change_from_baseline,
    "residential" = residential_percent_change_from_baseline,
     retail = labelise(retail_and_recreation_percent_change_from_baseline, "Variation du pourcentage de la fréquentation des zones de vente au détail et des loisirs par rapport à la base"),
    grocery = labelise(grocery, "Variation du pourcentage de la fréquentation des épiceries et pharmacies par rapport au niveau de base"), 
    parks = labelise(parks, "Variation du pourcentage de la fréquentation des parcs"), 
      transit = labelise(transit, "Variation en pourcentage de la fréquentation des stations de transit par rapport à la référence"), 
      workplaces = labelise(workplaces, "Variation en pourcentage de la fréquentation des lieux de travail par rapport à la base"),
      residential = labelise(residential, "Variation en pourcentage de la fréquentation des zones résidentielles par rapport à la base")
  ) -> feur
sselect(feur, c(1, 8, 9, 10, 11, 12, 13)) -> feur

```

```{r}
par(mfrow = c(3,2), mar = c(2,2,2,2))
retail_ts <- ts(feur$retail, start = c(2020, 46), frequency = 365)
grocery_ts <- ts(feur$grocery,  start = c(2020, 46), frequency = 365)
parks_ts <- ts(feur$parks,  start = c(2020, 46), frequency = 365)
transit_ts <- ts(feur$transit,  start = c(2020, 46), frequency = 365)
workplaces_ts <- ts(feur$workplaces,  start = c(2020, 46), frequency = 365)
residential_ts <- ts(feur$residential,  start = c(2020, 46), frequency = 365)
plot(retail_ts, main = "Fréquentation des lieux de vente au détail et loisirs")
plot(grocery_ts, main = "Fréquentation des épiceries et pharmacies")
plot(parks_ts, main = "Fréquentation des parcs")
plot(transit_ts, main = "Fréquentation des stations de transit")
plot(workplaces_ts, main = "Fréquentation des lieux de travail")
plot(residential_ts,main = "Fréquentation des zones résidentielles")

```

```{r Autocrrélation,spectre, tendantce des séries brutes}

set.seed(9037)
#par(mfrow = c(3,2), mar = c(2,2,2,2))
acf(retail_ts)
spectrum(retail_ts, spans = c(3, 5), main = "Fréquentation des lieux de vente au détail et loisirs")
retail_ts_trend<-trend.test(retail_ts, R = 999)
plot(retail_ts_trend)

acf(grocery_ts)
spectrum(grocery_ts, spans = c(3, 5), main = "Fréquentation des épiceries et pharmacies")
grocery_ts_trend<-trend.test(grocery_ts, R = 999)
plot(grocery_ts_trend)

#acf(parks_ts)
#spectrum(parks_ts, spans = c(3, 5), main = "Fréquentation des parcs")

acf(transit_ts)
spectrum(transit_ts, spans = c(3,5), main = "Fréquentation des stations de transit")
transit_ts_trend<-trend.test(transit_ts, R = 999)
plot(transit_ts_trend)

acf(workplaces_ts)
spectrum(workplaces_ts, spans = c(3,5), main = "Fréquentation des lieux de travail")
workplaces_ts_trend<-trend.test(workplaces_ts, R = 999)
plot(workplaces_ts_trend)


acf(residential_ts)
spectrum(residential_ts, spans = c(3,5),main = "Fréquentation des zones résidentielles")
residential_ts_trend<-trend.test(residential_ts, R = 999)
plot(residential_ts_trend, main = "Fréquentation des zones résidentielles")
# APPAREMMENT PAS DE TENDANCE POUR LA ZONE RESIDENTIELLE DONC PEUT ETRE PAS IMPORTANT 
# ESSAYER DE VOIR  si DIFFERENCE ENTRE PRE CONFINEMENT-CONFINEMENT-POST CONFINEMENT
# On peut regarder aussi différence semaine et weekend, peut être pour les mêmes périodes
#
```

```{r }
retail_diff<-tsd(retail_ts, method = "average", s.window = "periodic")
retail_loess<-tsd(retail_ts, method = "loess", s.window = 7, trend = TRUE)
plot(retail_diff)
plot(retail_loess, col = c(1:3))

retail_filt <- extract(retail_diff, components = "filtered")
spectrum(retail_filt, spans = c(3, 5))

retail_resid <- extract(retail_diff, components = "residuals")
spectrum(retail_resid, spans = c(3, 5))

retail_mts<-tseries(retail_loess)
fspec <- spectrum(retail_mts[, "seasonal"],spans = c(3,5))
rsspec <- spectrum(retail_mts[, "residuals"],spans = c(3,5))
```

```{r retail précovid}
retail_ts_conf<-window(retail_ts, end = c(2020, 126))
retail_diff_conf<-tsd(retail_ts_conf, method = "average", s.window = "periodic")

acf(retail_ts_conf)
plot(retail_diff_conf)

retail_filt_conf <- extract(retail_diff_conf, components = "filtered")
spectrum(retail_filt_conf, spans = c(3, 5))
```

Partie Achille

Partie Maxime

Partie Oguzhan

Je vais me concentrer sur workplace

```{r}
#Je me limite personnellement de fevrier à fin 2021 comme dit dans le read.me, car moins affecté après.
feur_OD<-  sfilter(feur, date >= as.Date("2020-02-15"),  date <= as.Date("2021-12-31"))

#Série journalière pour voir la dynamique brute 

workjour <- ts(feur_OD$workplaces, start = c(2020, 46), frequency = 365)
par(mfrow = c(2,2), mar = c(3, 3, 2, 1))
plot(workjour, main = "Fréquentation des lieux de travail (journalier)", ylab = "% par rapport à la base")
acf(workjour)
spectrum(workjour, span = c(3, 5))

set.seed(240303)
worktrend <- trend.test(workjour, R = 999)
plot(worktrend)


```

La série journalière montre une énorme chute début 2020 qui pourrait correspondre au confinement, puis une remontée progressive qui reste sous 0 jusqu'à fin 2021, ce qui colle avec le retour au travail présentiel.

L'ACF est composé de pics décroissants avec le temps. L'axe étant exprimé en années, le lag de 0.02 s'exprime en plus ou moins 7 jours (0.02 \* 365). Le motif en pics indiquent une possible saisonnalité hebdomadaire, les jours de semaine ont un profil similaire et les week-ends provoquent un même type de creux.

Le périodogramme lissé voit 2 pics significatifs, on voit donc 2 phénomènes répétés tous les 50 et 100 jours.

L'histogramme du trend test confirme la significativité de la tendance.

Passons maintenant à l'hebdomadaire.

```{r}
feurw <- feur_OD
feurw$weekday <- weekdays(as.POSIXct(feurw$date))

#On met NA a la place des w-e pour se concentrer sur les jours ouvrables.

feurw[feurw$weekday %in% c("Saturday", "Sunday", "samedi", "dimanche"), "workplaces"] <- NA
workdw <- ts(feurw$workplaces, start = c(2020, 46), frequency = 365)
workweek <- aggregate(workdw, 52, FUN = collapse::fmean, ts.eps = 1 / 52)
plot(workweek)

```

On voit très clairement une chute supérieure à 60% de la fréquentation des lieux de travail au début puis une remontée qui ne revient jamais vraiment au point de départ.

```{r}
par(mfrow = c(2,2), mar = c(3,3,2,1))

plot(workweek, main = "Fréquentation hebdomadaire des lieux de travail", ylab = "% par rapport à la base", xlab = "")
acf(workweek, main = "ACF - série hebdomadaire")
spectrum(workweek, spans = c(3,5), main = "Spectre - série hebdomadaire")
set.seed(240303)
workweek_trend <- trend.test(workweek, R = 999)
plot(workweek_trend, main = "Test de tendance - série hebdomadaire")
par(mfrow = c(1,1))
```

Sur l'échelle hebdomadaire, on voit la même histoire, avec une chute de plus de 60% des fréquentations des lieux de travail. L'ACF montre une forte autocorrélation positivie sur des petit lags qui décroit lentement, la série n'est pas stationnaire.

Les tendances persistent à l'échelle hebdomaire.

Décomposons maintenant la série hebdomadaire, elle semble plus propre que la journalière.

```{r}
#Vu la gueule des courbes, je vais faire une LOESS, en espérant que ça va gérer les petits effets de bords en même temps.
#workweek_loess <- tsd(workweek, method = "loess", s.window = 53, trend = TRUE) j'ai essayé mais il dit que la période totale est trop courte :((( je vais donc reprendre sans la coupure que j'ai fait au tout début de mon analyse
feur_OD2 <- sfilter(feur, date >= as.Date("2020-02-15"))
feurdw2 <- feur_OD2
feurdw2$weekday <- weekdays(as.POSIXct(feurdw2$date))
feurdw2[feurdw2$weekday %in% c("Saturday","Sunday","samedi","dimanche"), "workplaces"] <- NA
workdw2 <- ts(feurdw2$workplaces, start = c(2020, 46), frequency = 365)
workweek2 <- aggregate(workdw2, 52, FUN = collapse::fmean, ts.eps = 1/52)

#juste pour vérifier que ça ne change pas drastiquement 
plot(workweek2, main = "Fréquentation hebdomadaire des lieux de travail", ylab = "% par rapport à la base", xlab = "")
par(mfrow = c(2,2), mar = c(3,3,2,1))
plot(workweek2, main = "Fréquentation hebdomadaire des lieux de travail", ylab = "% par rapport à la base", xlab = "")
acf(workweek2, main = "ACF - série hebdomadaire")
spectrum(workweek2, spans = c(3,5), main = "Spectre - série hebdomadaire")
set.seed(240303)
workweek_trend_test <- trend.test(workweek2, R = 999)
plot(workweek_trend_test, main = "Test de tendance - série hebdomadaire")
par(mfrow = c(1,1))

workweek_loess <- tsd(workweek2, method = "loess", s.window = 53, trend = TRUE)
plot(workweek_loess, main = "Décomposition - lieux de travail (hebdom.)")

```

La série brute reprend ce qu'on a dit au début, il y a une très grosse réduction dans la fréquentation des lieux de travail au confinement. La tendance montre que que la fréquentation est remontée avec le temps tout en restant en dessous du niveau de référence. L'impact du covid n'a donc pas vraiment disparu.

La courbe seasonal identifie des motifs qui se répètent sur la durée, dont l'amplitude est modérée. Les creux marqués pourraient être l'hiver ou certains épisodes ou les mesures ont été de nouveau renforcés. La saisonalité reste plus petite que la tendance.

Partie Tanguy

```{r}

```

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
